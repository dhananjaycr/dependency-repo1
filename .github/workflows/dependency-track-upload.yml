name: Generate and Upload SBOM to Dependency-Track

on:
  workflow_dispatch:

env:
  DT_URL: https://dependabot.coinroutes.com:8081
  PROJECT_NAME: ${{ github.repository }}
  PROJECT_VERSION: ${{ github.run_number }}

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Verify workspace
        run: |
          pwd
          ls -la
          echo "Repository: ${{ github.repository }}"

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git
          
      - name: Setup Node.js
        run: |
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          node --version
          npm --version

      - name: Setup Python
        run: |
          sudo apt-get install -y python3.11 python3.11-venv python3-pip
          python3.11 --version
          python3.11 -m pip --version

      - name: Install CycloneDX tools
        run: |
          npm install -g @cyclonedx/cyclonedx-npm
          python3.11 -m pip install cyclonedx-bom

      - name: Generate SBOMs
        run: |
          if [ -f "app/package.json" ] || [ -f "package.json" ]; then
            if [ -f "app/package.json" ]; then
              cd app && cyclonedx-npm --output-file ../sbom-nodejs.json && cd ..
            else
              cyclonedx-npm --output-file sbom-nodejs.json
            fi
            echo "âœ… Node.js SBOM generated"
          else
            echo "âš ï¸  No package.json found, skipping Node.js SBOM"
            touch sbom-nodejs.json
            echo '{"bomFormat":"CycloneDX","specVersion":"1.4","version":1,"components":[]}' > sbom-nodejs.json
          fi
          
          if [ -f "requirements.txt" ]; then
            cyclonedx-bom -o sbom-python.json -r requirements.txt
            echo "âœ… Python SBOM generated"
          else
            echo "âš ï¸  No requirements.txt found, skipping Python SBOM"
            touch sbom-python.json
            echo '{"bomFormat":"CycloneDX","specVersion":"1.4","version":1,"components":[]}' > sbom-python.json
          fi

      - name: Install Trivy
        run: |
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Upload SBOMs to Dependency-Track
        run: |
          if [ -f "sbom-nodejs.json" ] && [ -s "sbom-nodejs.json" ] && [ "$(jq -r '.components | length' sbom-nodejs.json 2>/dev/null || echo 0)" != "0" ]; then
            echo "Uploading Node.js SBOM..."
            curl -X "PUT" "${{ env.DT_URL }}/api/v1/bom" \
              -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
              -H "Content-Type: multipart/form-data" \
              -F "projectName=${{ env.PROJECT_NAME }}" \
              -F "projectVersion=${{ env.PROJECT_VERSION }}" \
              -F "bom=@sbom-nodejs.json" \
              -F "autoCreate=true"
          fi
          
          if [ -f "sbom-python.json" ] && [ -s "sbom-python.json" ] && [ "$(jq -r '.components | length' sbom-python.json 2>/dev/null || echo 0)" != "0" ]; then
            echo "Uploading Python SBOM..."
            curl -X "PUT" "${{ env.DT_URL }}/api/v1/bom" \
              -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
              -H "Content-Type: multipart/form-data" \
              -F "projectName=${{ env.PROJECT_NAME }}" \
              -F "projectVersion=${{ env.PROJECT_VERSION }}" \
              -F "bom=@sbom-python.json" \
              -F "autoCreate=true"
          fi

      - name: Scan SBOMs with Trivy
        id: trivy_scan
        run: |
          echo "Scanning SBOMs with Trivy..."
          NODE_CRITICAL=0
          NODE_HIGH=0
          NODE_MEDIUM=0
          NODE_LOW=0
          PYTHON_CRITICAL=0
          PYTHON_HIGH=0
          PYTHON_MEDIUM=0
          PYTHON_LOW=0
          
          if [ -f "sbom-nodejs.json" ] && [ -s "sbom-nodejs.json" ] && [ "$(jq -r '.components | length' sbom-nodejs.json 2>/dev/null || echo 0)" != "0" ]; then
            trivy sbom --format json --output trivy-nodejs.json sbom-nodejs.json
            NODE_CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-nodejs.json 2>/dev/null || echo "0")
            NODE_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-nodejs.json 2>/dev/null || echo "0")
            NODE_MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-nodejs.json 2>/dev/null || echo "0")
            NODE_LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-nodejs.json 2>/dev/null || echo "0")
          fi
          
          if [ -f "sbom-python.json" ] && [ -s "sbom-python.json" ] && [ "$(jq -r '.components | length' sbom-python.json 2>/dev/null || echo 0)" != "0" ]; then
            trivy sbom --format json --output trivy-python.json sbom-python.json
            PYTHON_CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-python.json 2>/dev/null || echo "0")
            PYTHON_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-python.json 2>/dev/null || echo "0")
            PYTHON_MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-python.json 2>/dev/null || echo "0")
            PYTHON_LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-python.json 2>/dev/null || echo "0")
          fi
          
          TRIVY_CRITICAL=$((NODE_CRITICAL + PYTHON_CRITICAL))
          TRIVY_HIGH=$((NODE_HIGH + PYTHON_HIGH))
          TRIVY_MEDIUM=$((NODE_MEDIUM + PYTHON_MEDIUM))
          TRIVY_LOW=$((NODE_LOW + PYTHON_LOW))
          TRIVY_TOTAL=$((TRIVY_CRITICAL + TRIVY_HIGH + TRIVY_MEDIUM + TRIVY_LOW))
          
          echo "trivy_critical=$TRIVY_CRITICAL" >> $GITHUB_OUTPUT
          echo "trivy_high=$TRIVY_HIGH" >> $GITHUB_OUTPUT
          echo "trivy_medium=$TRIVY_MEDIUM" >> $GITHUB_OUTPUT
          echo "trivy_low=$TRIVY_LOW" >> $GITHUB_OUTPUT
          echo "trivy_total=$TRIVY_TOTAL" >> $GITHUB_OUTPUT

      - name: Get Dependency-Track metrics
        id: dt_metrics
        run: |
          echo "Waiting for Dependency-Track analysis..."
          sleep 30
          
          PROJECT_UUID=$(curl -s -X "GET" "${{ env.DT_URL }}/api/v1/project/lookup?name=${{ env.PROJECT_NAME }}&version=${{ env.PROJECT_VERSION }}" \
            -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" | jq -r '.uuid')
          
          # Wait for analysis to complete
          for i in {1..15}; do
            METRICS=$(curl -s -X "GET" "${{ env.DT_URL }}/api/v1/metrics/project/$PROJECT_UUID/current" \
              -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}")
            LAST_OCCURRENCE=$(echo $METRICS | jq -r '.lastOccurrence // empty')
            if [ -n "$LAST_OCCURRENCE" ] && [ "$LAST_OCCURRENCE" != "null" ]; then
              break
            fi
            echo "Waiting for analysis... ($i/15)"
            sleep 10
          done
          
          DT_CRITICAL=$(echo $METRICS | jq -r '.critical // 0')
          DT_HIGH=$(echo $METRICS | jq -r '.high // 0')
          DT_MEDIUM=$(echo $METRICS | jq -r '.medium // 0')
          DT_LOW=$(echo $METRICS | jq -r '.low // 0')
          DT_TOTAL=$(echo $METRICS | jq -r '.vulnerabilities // 0')
          
          echo "dt_critical=$DT_CRITICAL" >> $GITHUB_OUTPUT
          echo "dt_high=$DT_HIGH" >> $GITHUB_OUTPUT
          echo "dt_medium=$DT_MEDIUM" >> $GITHUB_OUTPUT
          echo "dt_low=$DT_LOW" >> $GITHUB_OUTPUT
          echo "dt_total=$DT_TOTAL" >> $GITHUB_OUTPUT

      - name: Display Comparison Report
        run: |
          echo ""
          echo "=========================================="
          echo "ğŸ“Š VULNERABILITY SCAN COMPARISON"
          echo "=========================================="
          echo ""
          echo "Project: ${{ env.PROJECT_NAME }}"
          echo "Version: ${{ env.PROJECT_VERSION }}"
          echo ""
          echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
          echo "â”‚ Severity        â”‚ Dependency-Track â”‚ Trivy      â”‚"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          printf "â”‚ ğŸ”´ Critical     â”‚ %12s â”‚ %12s â”‚\n" "${{ steps.dt_metrics.outputs.dt_critical }}" "${{ steps.trivy_scan.outputs.trivy_critical }}"
          printf "â”‚ ğŸŸ  High          â”‚ %12s â”‚ %12s â”‚\n" "${{ steps.dt_metrics.outputs.dt_high }}" "${{ steps.trivy_scan.outputs.trivy_high }}"
          printf "â”‚ ğŸŸ¡ Medium        â”‚ %12s â”‚ %12s â”‚\n" "${{ steps.dt_metrics.outputs.dt_medium }}" "${{ steps.trivy_scan.outputs.trivy_medium }}"
          printf "â”‚ ğŸŸ¢ Low           â”‚ %12s â”‚ %12s â”‚\n" "${{ steps.dt_metrics.outputs.dt_low }}" "${{ steps.trivy_scan.outputs.trivy_low }}"
          echo "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤"
          printf "â”‚ ğŸ“ˆ Total         â”‚ %12s â”‚ %12s â”‚\n" "${{ steps.dt_metrics.outputs.dt_total }}" "${{ steps.trivy_scan.outputs.trivy_total }}"
          echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
          echo ""
          echo "=========================================="
