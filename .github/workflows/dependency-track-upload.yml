name: Generate and Upload SBOM to Dependency-Track

on:
  workflow_dispatch:

env:
  DT_URL: https://dependabot.coinroutes.com:8081
  PROJECT_NAME: ${{ github.repository }}

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Checkout repository
        run: |
          git clone --depth 1 https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git .
          echo "Repository structure:"
          find . -type f -name "package.json" -o -name "requirements.txt" | head -20

      - name: Generate SBOM (CycloneDX)
        run: |
          trivy fs \
            --format cyclonedx \
            --output sbom.json \
            --scanners vuln,license,misconfig,secret \
            --ignore-unfixed \
            .

          echo "SBOM components count:"
          jq '.components | length' sbom.json || echo 0

      - name: Scan vulnerabilities with Trivy
        id: trivy
        run: |
          trivy fs --format json --severity CRITICAL,HIGH,MEDIUM,LOW . --scanners vuln > vulns.json

          echo "Scan summary:"
          jq '.Results[] | {Target: .Target, Count: (.Vulnerabilities | length)}' vulns.json || true
          
          for sev in CRITICAL HIGH MEDIUM LOW; do
            COUNT=$(jq "[.Results[]?.Vulnerabilities[]? | select(.Severity==\"$sev\")] | length" vulns.json)
            echo "${sev,,}=$COUNT" >> $GITHUB_OUTPUT
          done

          TOTAL=$(jq '[.Results[]?.Vulnerabilities[]?] | length' vulns.json)
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Check / Create Dependency-Track Project
        id: project
        run: |
          PROJECT_VERSION=$(date +%Y%m%d)
          
          # Search for project by name only
          PROJECTS=$(curl -s -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
            "${{ env.DT_URL }}/api/v1/project?name=${{ env.PROJECT_NAME }}")
          
          PROJECT_UUID=$(echo "$PROJECTS" | jq -r ".[] | select(.name==\"${{ env.PROJECT_NAME }}\") | .uuid" | head -1)
          
          if [ -z "$PROJECT_UUID" ]; then
            echo "Project not found - creating with version $PROJECT_VERSION"
            PROJECT_UUID=$(curl -s -X PUT "${{ env.DT_URL }}/api/v1/project" \
              -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
              -H "Content-Type: application/json" \
              -d "{\"name\":\"${{ env.PROJECT_NAME }}\",\"version\":\"$PROJECT_VERSION\"}" | jq -r '.uuid // empty')
            
            [ -z "$PROJECT_UUID" ] && echo "Creation failed" && exit 1
            echo "Project created: $PROJECT_UUID"
          else
            echo "Project exists: $PROJECT_UUID - uploading with version $PROJECT_VERSION"
          fi
          
          echo "uuid=$PROJECT_UUID" >> $GITHUB_OUTPUT
          echo "version=$PROJECT_VERSION" >> $GITHUB_OUTPUT

      - name: Upload SBOM
        run: |
          UUID=${{ steps.project.outputs.uuid }}
          VERSION=${{ steps.project.outputs.version }}

          if [ ! -s sbom.json ]; then
            echo "SBOM missing or empty"
            exit 1
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
            -X POST "${{ env.DT_URL }}/api/v1/bom" \
            -F "project=$UUID" \
            -F "projectVersion=$VERSION" \
            -F "bom=@sbom.json")

          CODE=$(echo "$RESPONSE" | tail -n1)

          if [ "$CODE" = "200" ] || [ "$CODE" = "201" ]; then
            echo "SBOM uploaded successfully (HTTP $CODE)"
          else
            echo "Upload failed: $RESPONSE"
            exit 1
          fi

      - name: Get Dependency-Track Metrics
        id: dt
        run: |
          UUID=${{ steps.project.outputs.uuid }}

          sleep 25

          METRICS=$(curl -s -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
            "${{ env.DT_URL }}/api/v1/metrics/project/$UUID/current")

          for sev in critical high medium low; do
            VAL=$(echo "$METRICS" | jq -r ".${sev} // 0")
            echo "$sev=$VAL" >> $GITHUB_OUTPUT
          done

          TOTAL=$(echo "$METRICS" | jq -r '.vulnerabilities // 0')
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "Compare:"
          printf "Critical: DT=%s  Trivy=%s\n" "${{ steps.dt.outputs.critical }}" "${{ steps.trivy.outputs.critical }}"
