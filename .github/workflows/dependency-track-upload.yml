name: Generate and Upload SBOM to Dependency-Track

on:
  workflow_dispatch:

env:
  DT_URL: https://dependabot.coinroutes.com:8081
  PROJECT_NAME: ${{ github.repository }}
  PROJECT_VERSION: ${{ github.run_number }}

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git wget apt-transport-https gnupg lsb-release python3 python3-pip
          curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
          sudo apt-get install -y nodejs
          npm install -g @cyclonedx/cyclonedx-npm
          python3 -m pip install cyclonedx-bom
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update && sudo apt-get install -y trivy

      - name: Checkout code
        run: |
          git clone --depth 1 --branch ${{ github.ref_name }} https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git .

      - name: Install dependencies
        run: |
          if [ -f "app/package.json" ]; then
            cd app && npm install --no-audit --no-fund --package-lock-only && cd ..
          elif [ -f "package.json" ]; then
            npm install --no-audit --no-fund --package-lock-only
          fi

      - name: Generate SBOMs
        run: |
          if [ -f "app/package.json" ]; then
            cd app && cyclonedx-npm --output-file ../sbom-nodejs.json && cd ..
          elif [ -f "package.json" ]; then
            cyclonedx-npm --output-file sbom-nodejs.json
          else
            echo '{"bomFormat":"CycloneDX","specVersion":"1.4","version":1,"components":[]}' > sbom-nodejs.json
          fi
          
          if [ -f "requirements.txt" ]; then
            cyclonedx-bom -o sbom-python.json -r requirements.txt
          else
            echo '{"bomFormat":"CycloneDX","specVersion":"1.4","version":1,"components":[]}' > sbom-python.json
          fi

      - name: Upload SBOMs
        run: |
          upload_sbom() {
            local file=$1
            [ -f "$file" ] && [ -s "$file" ] && [ "$(jq -r '.components | length' "$file" 2>/dev/null || echo 0)" != "0" ] && \
            curl -s -X "PUT" "${{ env.DT_URL }}/api/v1/bom" \
              -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
              -H "Content-Type: multipart/form-data" \
              -F "projectName=${{ env.PROJECT_NAME }}" \
              -F "projectVersion=${{ env.PROJECT_VERSION }}" \
              -F "bom=@$file" \
              -F "autoCreate=true" > /dev/null && echo "âœ… Uploaded $(basename $file)" || echo "âš ï¸  Skipped $(basename $file)"
          }
          upload_sbom sbom-nodejs.json
          upload_sbom sbom-python.json

      - name: Scan with Trivy
        id: trivy
        run: |
          scan_sbom() {
            local input=$1 output=$2
            [ -f "$input" ] && [ -s "$input" ] && [ "$(jq -r '.components | length' "$input" 2>/dev/null || echo 0)" != "0" ] && \
            trivy sbom --format json --output "$output" "$input" 2>/dev/null || echo '{"Results":[]}' > "$output"
          }
          
          scan_sbom sbom-nodejs.json trivy-nodejs.json
          scan_sbom sbom-python.json trivy-python.json
          
          count_vulns() {
            local file=$1 severity=$2
            jq "[.Results[]?.Vulnerabilities[]? | select(.Severity==\"$severity\")] | length" "$file" 2>/dev/null || echo 0
          }
          
          CRITICAL=$(($(count_vulns trivy-nodejs.json CRITICAL) + $(count_vulns trivy-python.json CRITICAL)))
          HIGH=$(($(count_vulns trivy-nodejs.json HIGH) + $(count_vulns trivy-python.json HIGH)))
          MEDIUM=$(($(count_vulns trivy-nodejs.json MEDIUM) + $(count_vulns trivy-python.json MEDIUM)))
          LOW=$(($(count_vulns trivy-nodejs.json LOW) + $(count_vulns trivy-python.json LOW)))
          TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))
          
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Get Dependency-Track metrics
        id: dt
        run: |
          sleep 30
          UUID=$(curl -s -X "GET" "${{ env.DT_URL }}/api/v1/project/lookup?name=${{ env.PROJECT_NAME }}&version=${{ env.PROJECT_VERSION }}" \
            -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" | jq -r '.uuid')
          
          for i in {1..15}; do
            METRICS=$(curl -s -X "GET" "${{ env.DT_URL }}/api/v1/metrics/project/$UUID/current" \
              -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}")
            [ -n "$(echo $METRICS | jq -r '.lastOccurrence // empty' 2>/dev/null)" ] && break
            [ $i -lt 15 ] && sleep 10
          done
          
          echo "critical=$(echo $METRICS | jq -r '.critical // 0')" >> $GITHUB_OUTPUT
          echo "high=$(echo $METRICS | jq -r '.high // 0')" >> $GITHUB_OUTPUT
          echo "medium=$(echo $METRICS | jq -r '.medium // 0')" >> $GITHUB_OUTPUT
          echo "low=$(echo $METRICS | jq -r '.low // 0')" >> $GITHUB_OUTPUT
          echo "total=$(echo $METRICS | jq -r '.vulnerabilities // 0')" >> $GITHUB_OUTPUT

      - name: Display results
        run: |
          printf "\n==========================================\n"
          printf "ğŸ“Š VULNERABILITY SCAN COMPARISON\n"
          printf "==========================================\n\n"
          printf "Project: ${{ env.PROJECT_NAME }}\n"
          printf "Version: ${{ env.PROJECT_VERSION }}\n\n"
          printf "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n"
          printf "â”‚ Severity     â”‚ Dependency-Track â”‚ Trivy    â”‚\n"
          printf "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n"
          printf "â”‚ ğŸ”´ Critical  â”‚ %16s â”‚ %8s â”‚\n" "${{ steps.dt.outputs.critical }}" "${{ steps.trivy.outputs.critical }}"
          printf "â”‚ ğŸŸ  High       â”‚ %16s â”‚ %8s â”‚\n" "${{ steps.dt.outputs.high }}" "${{ steps.trivy.outputs.high }}"
          printf "â”‚ ğŸŸ¡ Medium     â”‚ %16s â”‚ %8s â”‚\n" "${{ steps.dt.outputs.medium }}" "${{ steps.trivy.outputs.medium }}"
          printf "â”‚ ğŸŸ¢ Low        â”‚ %16s â”‚ %8s â”‚\n" "${{ steps.dt.outputs.low }}" "${{ steps.trivy.outputs.low }}"
          printf "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n"
          printf "â”‚ ğŸ“ˆ Total      â”‚ %16s â”‚ %8s â”‚\n" "${{ steps.dt.outputs.total }}" "${{ steps.trivy.outputs.total }}"
          printf "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n"
          printf "==========================================\n"
