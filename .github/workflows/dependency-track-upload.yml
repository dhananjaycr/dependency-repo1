name: Generate and Upload SBOM to Dependency-Track

on:
  workflow_dispatch:

env:
  DT_URL: https://dependabot.coinroutes.com:8081
  PROJECT_NAME: ${{ github.repository }}

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    env:
      DT_API_KEY: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Checkout repository
        run: |
          git clone --depth 1 https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git .
          echo "Repository structure:"
          find . -type f -name "package.json" -o -name "requirements.txt" | head -20

      - name: Generate SBOM (CycloneDX)
        run: |
          set -e
          
          echo "Generating SBOM with Trivy..."
          if ! trivy fs --format cyclonedx --output sbom.json --scanners vuln,license,misconfig,secret --ignore-unfixed .; then
            echo "ERROR: SBOM generation failed"
            exit 1
          fi
          
          if [ ! -f "sbom.json" ]; then
            echo "ERROR: SBOM file was not created"
            exit 1
          fi
          
          COMPONENT_COUNT=$(jq '.components | length' sbom.json 2>/dev/null || echo "0")
          echo "✅ SBOM generated successfully"
          echo "  Components: $COMPONENT_COUNT"

      - name: Scan vulnerabilities with Trivy
        id: trivy
        run: |
          trivy fs --format json --severity CRITICAL,HIGH,MEDIUM,LOW . --scanners vuln > vulns.json

          echo "Scan summary:"
          jq '.Results[] | {Target: .Target, Count: (.Vulnerabilities | length)}' vulns.json || true
          
          for sev in CRITICAL HIGH MEDIUM LOW; do
            COUNT=$(jq "[.Results[]?.Vulnerabilities[]? | select(.Severity==\"$sev\")] | length" vulns.json)
            echo "${sev,,}=$COUNT" >> $GITHUB_OUTPUT
          done

          TOTAL=$(jq '[.Results[]?.Vulnerabilities[]?] | length' vulns.json)
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Upload SBOM to Dependency-Track
        id: upload
        run: |
          PROJECT_VERSION=$(date +%Y%m%d)
          PROJECT_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          
          echo "Step 1: Validating SBOM file..."
          if [ ! -f "sbom.json" ]; then
            echo "ERROR: sbom.json file not found"
            exit 1
          fi
          
          if [ ! -s "sbom.json" ]; then
            echo "ERROR: sbom.json file is empty"
            exit 1
          fi
          
          SBOM_SIZE=$(wc -c < sbom.json)
          echo "✅ SBOM file found: $SBOM_SIZE bytes"
          
          echo "Step 2: Uploading SBOM..."
          echo "  Project: $PROJECT_NAME"
          echo "  Version: $PROJECT_VERSION"
          echo "  URL: $DT_URL/api/v1/bom"
          echo "  SBOM file: $(ls -lh sbom.json | awk '{print $5}')"
          echo ""
          
          echo "Testing connection..."
          if ! curl --max-time 10 --connect-timeout 5 -s -o /dev/null -w "%{http_code}" "$DT_URL/api/v1/version" > /dev/null 2>&1; then
            echo "WARNING: Could not reach Dependency-Track server"
          else
            echo "✅ Server is reachable"
          fi
          
          echo "Starting upload (this may take a moment for large files)..."
          
          RESPONSE=$(curl --max-time 180 --connect-timeout 30 --show-error \
            -w "\nHTTP_CODE:%{http_code}\nTIME_TOTAL:%{time_total}s" \
            -H "X-Api-Key: $DT_API_KEY" \
            -X POST "$DT_URL/api/v1/bom" \
            -F "projectName=$PROJECT_NAME" \
            -F "projectVersion=$PROJECT_VERSION" \
            -F "bom=@sbom.json" \
            -F "autoCreate=true" 2>&1)
          
          CURL_EXIT=$?
          echo ""
          echo "Upload completed. Exit code: $CURL_EXIT"
          
          if [ $CURL_EXIT -ne 0 ]; then
            echo "ERROR: Curl failed (exit code $CURL_EXIT)"
            echo "Exit code 28 = timeout"
            echo "Full response:"
            echo "$RESPONSE"
            exit 1
          fi
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE" | cut -d: -f2 || echo "")
          BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE" || echo "")
          
          if [ -z "$HTTP_CODE" ]; then
            echo "ERROR: No HTTP code received"
            echo "Response: $RESPONSE"
            exit 1
          fi
          
          if [ "$HTTP_CODE" != "200" ]; then
            echo "ERROR: Upload failed"
            echo "  HTTP Code: $HTTP_CODE"
            echo "  Response: $BODY"
            exit 1
          fi
          
          echo "✅ SBOM uploaded successfully"
          TOKEN=$(echo "$BODY" | jq -r '.token // empty' 2>/dev/null || echo "")
          [ -n "$TOKEN" ] && echo "  Token: $TOKEN"
          
          echo "Step 3: Getting project UUID..."
          sleep 2
          
          PROJECT_UUID=$(curl --max-time 30 -s -H "X-Api-Key: $DT_API_KEY" \
            "$DT_URL/api/v1/project/lookup?name=$PROJECT_NAME&version=$PROJECT_VERSION" | jq -r '.uuid // empty' 2>/dev/null || echo "")
          
          if [ -z "$PROJECT_UUID" ] || [ "$PROJECT_UUID" = "null" ]; then
            echo "WARNING: Could not get project UUID"
            echo "  This may be normal if analysis is still processing"
            PROJECT_UUID=""
          else
            echo "✅ Project UUID: $PROJECT_UUID"
          fi
          
          echo "uuid=$PROJECT_UUID" >> $GITHUB_OUTPUT
          echo "version=$PROJECT_VERSION" >> $GITHUB_OUTPUT

      - name: Get Dependency-Track Metrics
        id: dt
        run: |
          UUID=${{ steps.upload.outputs.uuid }}

          if [ -z "$UUID" ]; then
            echo "WARNING: No project UUID available, skipping metrics"
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "medium=0" >> $GITHUB_OUTPUT
            echo "low=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Step 4: Waiting for analysis to complete..."
          sleep 25

          echo "Step 5: Fetching metrics..."
          METRICS=$(curl --max-time 30 -s -H "X-Api-Key: $DT_API_KEY" \
            "$DT_URL/api/v1/metrics/project/$UUID/current")

          if [ -z "$METRICS" ]; then
            echo "WARNING: No metrics returned"
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "medium=0" >> $GITHUB_OUTPUT
            echo "low=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          for sev in critical high medium low; do
            VAL=$(echo "$METRICS" | jq -r ".${sev} // 0" 2>/dev/null || echo "0")
            echo "$sev=$VAL" >> $GITHUB_OUTPUT
          done

          TOTAL=$(echo "$METRICS" | jq -r '.vulnerabilities // 0' 2>/dev/null || echo "0")
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          
          echo "✅ Metrics retrieved successfully"

      - name: Summary
        run: |
          echo "Compare:"
          printf "Critical: DT=%s  Trivy=%s\n" "${{ steps.dt.outputs.critical }}" "${{ steps.trivy.outputs.critical }}"
