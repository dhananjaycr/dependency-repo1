name: Generate and Upload SBOM to Dependency-Track

on:
  workflow_dispatch:

env:
  DT_URL: https://dependabot.coinroutes.com:8081
  PROJECT_NAME: ${{ github.repository }}
  PROJECT_VERSION: ${{ github.run_number }}

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
          sudo apt-get update && sudo apt-get install -y trivy

      - name: Checkout repository
        run: |
          git clone --depth 1 --branch ${{ github.ref_name }} https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git .

      - name: Generate SBOM with Trivy
        run: |
          trivy fs --format cyclonedx --output sbom.json .

      - name: Scan vulnerabilities with Trivy
        id: trivy
        run: |
          trivy fs --format json --severity CRITICAL,HIGH,MEDIUM,LOW . > vulns.json
          
          count_vulns() {
            local severity=$1
            jq "[.Results[]?.Vulnerabilities[]? | select(.Severity==\"$severity\")] | length" vulns.json 2>/dev/null || echo 0
          }
          
          CRITICAL=$(count_vulns CRITICAL)
          HIGH=$(count_vulns HIGH)
          MEDIUM=$(count_vulns MEDIUM)
          LOW=$(count_vulns LOW)
          TOTAL=$((CRITICAL + HIGH + MEDIUM + LOW))
          
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT
          echo "medium=$MEDIUM" >> $GITHUB_OUTPUT
          echo "low=$LOW" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Create Dependency-Track project
        id: create_project
        run: |
          PROJECT_UUID=$(curl -s -X PUT "${{ env.DT_URL }}/api/v1/project" \
            -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
            -H "Content-Type: application/json" \
            -d "{\"name\":\"${{ env.PROJECT_NAME }}\",\"version\":\"${{ env.PROJECT_VERSION }}\"}" | jq -r '.uuid // empty')
          
          if [ -z "$PROJECT_UUID" ]; then
            PROJECT_UUID=$(curl -s -X "GET" "${{ env.DT_URL }}/api/v1/project/lookup?name=${{ env.PROJECT_NAME }}&version=${{ env.PROJECT_VERSION }}" \
              -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" | jq -r '.uuid')
          fi
          
          echo "uuid=$PROJECT_UUID" >> $GITHUB_OUTPUT
          echo "Project UUID: $PROJECT_UUID"

      - name: Upload SBOM to Dependency-Track
        run: |
          if [ -f "sbom.json" ] && [ -s "sbom.json" ]; then
            curl -s -X POST "${{ env.DT_URL }}/api/v1/bom" \
              -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
              -F "project=${{ steps.create_project.outputs.uuid }}" \
              -F "bom=@sbom.json" && echo "âœ… Uploaded SBOM successfully"
          else
            echo "âš ï¸  No SBOM generated"
          fi

      - name: Get Dependency-Track metrics
        id: dt
        run: |
          sleep 30
          for i in {1..15}; do
            METRICS=$(curl -s -X "GET" "${{ env.DT_URL }}/api/v1/metrics/project/${{ steps.create_project.outputs.uuid }}/current" \
              -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}")
            [ -n "$(echo $METRICS | jq -r '.lastOccurrence // empty' 2>/dev/null)" ] && break
            [ $i -lt 15 ] && sleep 10
          done
          
          echo "critical=$(echo $METRICS | jq -r '.critical // 0')" >> $GITHUB_OUTPUT
          echo "high=$(echo $METRICS | jq -r '.high // 0')" >> $GITHUB_OUTPUT
          echo "medium=$(echo $METRICS | jq -r '.medium // 0')" >> $GITHUB_OUTPUT
          echo "low=$(echo $METRICS | jq -r '.low // 0')" >> $GITHUB_OUTPUT
          echo "total=$(echo $METRICS | jq -r '.vulnerabilities // 0')" >> $GITHUB_OUTPUT

      - name: Display results
        run: |
          printf "\n==========================================\n"
          printf "ğŸ“Š VULNERABILITY SCAN COMPARISON\n"
          printf "==========================================\n\n"
          printf "Project: ${{ env.PROJECT_NAME }}\n"
          printf "Version: ${{ env.PROJECT_VERSION }}\n\n"
          printf "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”\n"
          printf "â”‚ Severity     â”‚ Dependency-Track â”‚ Trivy    â”‚\n"
          printf "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n"
          printf "â”‚ ğŸ”´ Critical  â”‚ %16s â”‚ %8s â”‚\n" "${{ steps.dt.outputs.critical }}" "${{ steps.trivy.outputs.critical }}"
          printf "â”‚ ğŸŸ  High       â”‚ %16s â”‚ %8s â”‚\n" "${{ steps.dt.outputs.high }}" "${{ steps.trivy.outputs.high }}"
          printf "â”‚ ğŸŸ¡ Medium     â”‚ %16s â”‚ %8s â”‚\n" "${{ steps.dt.outputs.medium }}" "${{ steps.trivy.outputs.medium }}"
          printf "â”‚ ğŸŸ¢ Low        â”‚ %16s â”‚ %8s â”‚\n" "${{ steps.dt.outputs.low }}" "${{ steps.trivy.outputs.low }}"
          printf "â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤\n"
          printf "â”‚ ğŸ“ˆ Total      â”‚ %16s â”‚ %8s â”‚\n" "${{ steps.dt.outputs.total }}" "${{ steps.trivy.outputs.total }}"
          printf "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜\n"
          printf "==========================================\n"
