name: Generate and Upload SBOM to Dependency-Track

on:
  workflow_dispatch:

env:
  DT_URL: https://dependabot.coinroutes.com:8081
  PROJECT_NAME: ${{ github.repository }}

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Checkout repository
        run: |
          git clone --depth 1 https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git .
          echo "Repository structure:"
          find . -type f -name "package.json" -o -name "requirements.txt" | head -20

      - name: Generate SBOM (CycloneDX)
        run: |
          trivy fs \
            --format cyclonedx \
            --output sbom.json \
            --scanners vuln,license,misconfig,secret \
            --ignore-unfixed \
            .

          echo "SBOM components count:"
          jq '.components | length' sbom.json || echo 0

      - name: Scan vulnerabilities with Trivy
        id: trivy
        run: |
          trivy fs --format json --severity CRITICAL,HIGH,MEDIUM,LOW . --scanners vuln > vulns.json

          echo "Scan summary:"
          jq '.Results[] | {Target: .Target, Count: (.Vulnerabilities | length)}' vulns.json || true
          
          for sev in CRITICAL HIGH MEDIUM LOW; do
            COUNT=$(jq "[.Results[]?.Vulnerabilities[]? | select(.Severity==\"$sev\")] | length" vulns.json)
            echo "${sev,,}=$COUNT" >> $GITHUB_OUTPUT
          done

          TOTAL=$(jq '[.Results[]?.Vulnerabilities[]?] | length' vulns.json)
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Upload SBOM to Dependency-Track
        id: upload
        run: |
          PROJECT_VERSION=$(date +%Y%m%d)
          PROJECT_NAME=$(echo "${{ github.repository }}" | cut -d'/' -f2)
          
          if [ ! -s sbom.json ]; then
            echo "SBOM missing or empty"
            exit 1
          fi

          echo "Uploading SBOM with projectName=$PROJECT_NAME, version=$PROJECT_VERSION"
          
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" \
            -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
            -X POST "${{ env.DT_URL }}/api/v1/bom" \
            -F "projectName=$PROJECT_NAME" \
            -F "projectVersion=$PROJECT_VERSION" \
            -F "bom=@sbom.json" \
            -F "autoCreate=true")

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE" | cut -d: -f2)
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "✅ SBOM uploaded successfully"
            TOKEN=$(echo "$RESPONSE" | grep -v "HTTP_CODE" | jq -r '.token // empty')
            echo "Upload token: $TOKEN"
          else
            echo "❌ Upload failed: $RESPONSE"
            exit 1
          fi
          
          # Get project UUID for metrics
          sleep 2
          PROJECT_UUID=$(curl -s -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
            "${{ env.DT_URL }}/api/v1/project/lookup?name=$PROJECT_NAME&version=$PROJECT_VERSION" | jq -r '.uuid // empty')
          
          if [ -z "$PROJECT_UUID" ]; then
            echo "⚠️  Could not get project UUID, but upload succeeded"
          else
            echo "Project UUID: $PROJECT_UUID"
          fi
          
          echo "uuid=$PROJECT_UUID" >> $GITHUB_OUTPUT
          echo "version=$PROJECT_VERSION" >> $GITHUB_OUTPUT

      - name: Get Dependency-Track Metrics
        id: dt
        run: |
          UUID=${{ steps.upload.outputs.uuid }}

          if [ -z "$UUID" ]; then
            echo "⚠️  No project UUID available"
            echo "critical=0" >> $GITHUB_OUTPUT
            echo "high=0" >> $GITHUB_OUTPUT
            echo "medium=0" >> $GITHUB_OUTPUT
            echo "low=0" >> $GITHUB_OUTPUT
            echo "total=0" >> $GITHUB_OUTPUT
            exit 0
          fi

          sleep 25

          METRICS=$(curl -s -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
            "${{ env.DT_URL }}/api/v1/metrics/project/$UUID/current")

          for sev in critical high medium low; do
            VAL=$(echo "$METRICS" | jq -r ".${sev} // 0")
            echo "$sev=$VAL" >> $GITHUB_OUTPUT
          done

          TOTAL=$(echo "$METRICS" | jq -r '.vulnerabilities // 0')
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      - name: Summary
        run: |
          echo "Compare:"
          printf "Critical: DT=%s  Trivy=%s\n" "${{ steps.dt.outputs.critical }}" "${{ steps.trivy.outputs.critical }}"
