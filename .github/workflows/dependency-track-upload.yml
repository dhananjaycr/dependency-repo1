name: Generate and Upload SBOM to Dependency-Track

on:
  workflow_dispatch:

env:
  DT_URL: https://dependabot.coinroutes.com:8081
  PROJECT_NAME: ${{ github.repository }}
  PROJECT_VERSION: ${{ github.run_id }}-${{ github.run_number }}-$(date +'%Y%m%d')

jobs:
  generate-and-upload:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
          echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Checkout repository
        run: |
          git clone --depth 1 https://x-access-token:${{ github.token }}@github.com/${{ github.repository }}.git .
          echo "Repository structure:"
          find . -type f -name "*.json" -o -name "requirements.txt" -o -name "go.mod" | head -20

      # --- SBOM Generation ---
      - name: Generate SBOM (CycloneDX)
        run: |
          trivy fs \
            --format cyclonedx \
            --output sbom.json \
            --scanners vuln,license,misconfig,secret \
            --ignore-unfixed \
            --include-os-pkgs \
            --include-dev-deps \
            .

          echo "SBOM components count:"
          jq '.components | length' sbom.json || echo 0

      # --- Vulnerability Scan Output ---
      - name: Scan vulnerabilities with Trivy
        id: trivy
        run: |
          trivy fs --format json --severity CRITICAL,HIGH,MEDIUM,LOW . --scanners vuln > vulns.json
          
          echo "Scanning results summary:"
          jq '.Results[] | {Target: .Target, VulnCount: (.Vulnerabilities | length)}' vulns.json || true
          
          for sev in CRITICAL HIGH MEDIUM LOW; do
            COUNT=$(jq "[.Results[]?.Vulnerabilities[]? | select(.Severity==\"$sev\")] | length" vulns.json 2>/dev/null)
            echo "${sev,,}=$COUNT" >> $GITHUB_OUTPUT
          done

          TOTAL=$(jq '[.Results[]?.Vulnerabilities[]?] | length' vulns.json 2>/dev/null)
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      # --- CREATE or LOOKUP PROJECT ---
      - name: Check / Create Dependency-Track Project
        id: project
        run: |
          echo "Checking if project exists: ${{ env.PROJECT_NAME }} version ${{ env.PROJECT_VERSION }}"

          LOOKUP_URL="${{ env.DT_URL }}/api/v1/project/lookup?name=${{ env.PROJECT_NAME }}&version=${{ env.PROJECT_VERSION }}"

          PROJECT_UUID=$(curl -s -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" "$LOOKUP_URL" | jq -r '.uuid // empty')

          if [ -z "$PROJECT_UUID" ]; then
            echo "Project not found. Creating..."
            CREATE_BODY=$(jq -n \
              --arg name "${{ env.PROJECT_NAME }}" \
              --arg version "${{ env.PROJECT_VERSION }}" \
              '{name: $name, version: $version}')

            PROJECT_UUID=$(curl -s \
              -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
              -H "Content-Type: application/json" \
              -X PUT "${{ env.DT_URL }}/api/v1/project" \
              -d "$CREATE_BODY" | jq -r '.uuid // empty')

            if [ -z "$PROJECT_UUID" ]; then
              echo "Failed to create project"
              exit 1
            fi

            echo "Created project UUID: $PROJECT_UUID"
          else
            echo "Project exists: $PROJECT_UUID"
          fi

          echo "uuid=$PROJECT_UUID" >> $GITHUB_OUTPUT

      # --- UPLOAD SBOM ---
      - name: Upload SBOM to Dependency-Track
        run: |
          if [ ! -s sbom.json ]; then
            echo "SBOM missing or empty. Cannot upload."
            exit 1
          fi
          
          echo "Uploading SBOM..."
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
            -X POST "${{ env.DT_URL }}/api/v1/bom" \
            -F "project=${{ steps.project.outputs.uuid }}" \
            -F "bom=@sbom.json")

          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

          if [ "$HTTP_CODE" != "200" ] && [ "$HTTP_CODE" != "201" ]; then
            echo "SBOM upload failed: $RESPONSE"
            exit 1
          fi

          echo "SBOM upload ok (HTTP $HTTP_CODE)"

      # --- METRICS ---
      - name: Get Dependency-Track metrics
        id: dt
        run: |
          UUID=${{ steps.project.outputs.uuid }}

          echo "Waiting for analysis..."
          sleep 25

          METRICS=$(curl -s -H "X-Api-Key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}" \
            "${{ env.DT_URL }}/api/v1/metrics/project/$UUID/current")

          for sev in critical high medium low; do
            VAL=$(echo "$METRICS" | jq -r ".${sev} // 0")
            echo "${sev}=$VAL" >> $GITHUB_OUTPUT
          done

          TOTAL=$(echo "$METRICS" | jq -r '.vulnerabilities // 0')
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

      # --- SUMMARY ---
      - name: Display results
        run: |
          echo ""
          echo "=========================================="
          echo "  Vulnerability Comparison"
          echo "=========================================="
          printf "Critical: DT=%s  Trivy=%s\n" "${{ steps.dt.outputs.critical }}" "${{ steps.trivy.outputs.critical }}"
          printf "High:     DT=%s  Trivy=%s\n" "${{ steps.dt.outputs.high }}" "${{ steps.trivy.outputs.high }}"
          printf "Medium:   DT=%s  Trivy=%s\n" "${{ steps.dt.outputs.medium }}" "${{ steps.trivy.outputs.medium }}"
          printf "Low:      DT=%s  Trivy=%s\n" "${{ steps.dt.outputs.low }}" "${{ steps.trivy.outputs.low }}"
          echo "=========================================="
